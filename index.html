<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>K@WET ‚Ä¢ Ham Radio</title>
  <meta name="description" content="A clean, modern ham radio station template." />
  <meta name="color-scheme" content="dark light" />
  <script>
    window.SECTION_TOGGLES = { home: true, about: true, station: true, links: true, contact: true };
  </script>
<style>
  :root {
    --bg: hsl(220 15% 98%);
    --card: hsl(0 0% 100% / 0.78);
    --text: hsl(222 47% 11%);
    --muted: hsl(215 16% 47%);
    --border: hsl(210 16% 90%);
    --accent: hsl(205 85% 52%);
    --accent-2: hsl(268 79% 58%);
    --accent-3: hsl(156 72% 42%);
    --shadow: 0 10px 30px -10px hsl(220 60% 40% / 0.25);
    --radius: 16px;
    --container: 1100px;
    /* Background blending helpers */
    --bg-blob-1: hsl(200 100% 85% / 0.35);
    --bg-blob-2: hsl(280 100% 85% / 0.25);
    --bg-vignette: hsl(220 15% 5% / 0.12);
    --glass: blur(10px) saturate(110%);
  }
  [data-theme="dark"] {
    --bg: hsl(222 47% 7%);
    --card: hsl(222 36% 10% / 0.52);
    --text: hsl(210 20% 98%);
    --muted: hsl(215 16% 72%);
    --border: hsl(222 18% 20%);
    --accent: hsl(190 95% 60%);
    --accent-2: hsl(268 95% 70%);
    --accent-3: hsl(156 90% 46%);
    --shadow: 0 10px 30px -10px hsl(200 100% 60% / 0.22);
    --bg-blob-1: hsl(200 100% 65% / 0.18);
    --bg-blob-2: hsl(280 100% 65% / 0.14);
    --bg-vignette: hsl(0 0% 0% / 0.35);
    --glass: blur(12px) saturate(120%);
  }

  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    color: var(--text);
    background: var(--bg);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* Fixed background layer that softly blends with content */
  body::before, body::after { content:""; position: fixed; inset:0; pointer-events:none; z-index:-1; }
  body::before {
    background:
      radial-gradient(1200px 520px at 12% -12%, var(--bg-blob-1), transparent 60%),
      radial-gradient(1200px 520px at 88% -6%, var(--bg-blob-2), transparent 60%);
    background-attachment: fixed;
    mask-image: linear-gradient(180deg, rgba(0,0,0,.9), rgba(0,0,0,.75) 30%, rgba(0,0,0,.6) 55%, rgba(0,0,0,.5));
  }
  body::after {
    background:
      radial-gradient(100% 60% at 50% -10%, transparent 40%, var(--bg) 100%),
      radial-gradient(140% 120% at 50% 120%, var(--bg-vignette), transparent 60%),
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 140 140'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/><feComponentTransfer><feFuncA type='table' tableValues='0 0 0 0 .05 .07 .05 0 0 0 0 0'/></feComponentTransfer></filter><rect width='100%' height='100%' filter='url(%23n)'/></svg>") repeat;
    background-size: auto, auto, 220px 220px;
    mix-blend-mode: soft-light;
    opacity: .9;
  }

  a { color: var(--accent); text-decoration: none; }
  a:hover { text-decoration: underline; }
  [hidden]{ display: none !important; }

  .container { width: min(100%, var(--container)); margin: 0 auto; padding: 0 20px; }

  .site-header { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(1.2) blur(10px); background: linear-gradient(180deg, hsl(0 0% 100% / 0.75), hsl(0 0% 100% / 0)); border-bottom: 1px solid var(--border); }
  [data-theme="dark"] .site-header { background: linear-gradient(180deg, hsl(222 36% 10% / 0.72), transparent); }

  nav { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; gap: 16px; }
  .brand { display:flex; align-items:center; gap: 10px; font-weight: 700; letter-spacing: .6px; }
  .brand .dot { width:10px; height:10px; border-radius:50%; background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: 0 0 0 3px hsl(200 90% 60% / .18); animation: pulseDot 2.4s ease-in-out infinite; will-change: transform, box-shadow; }
  @keyframes pulseDot {
    0%, 100% { transform: scale(1); box-shadow: 0 0 0 3px hsl(200 90% 60% / .18), 0 0 0 0 hsl(200 90% 60% / 0); }
    50% { transform: scale(1.12); box-shadow: 0 0 0 6px hsl(200 90% 60% / .22), 0 0 20px 6px hsl(200 90% 60% / .35); }
  }
  @media (prefers-reduced-motion: reduce) { .brand .dot { animation: none; } }
  .brand small { color: var(--muted); font-weight: 500; }

  .nav-links { display:flex; gap: 18px; flex-wrap: wrap; }
  .nav-links a { color: var(--text); opacity: .8; font-weight: 600; }
  .nav-links a.active, .nav-links a:hover { opacity: 1; color: var(--accent); }

  .controls { display:flex; gap: 10px; align-items:center; }
  .btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.6rem 1rem; border-radius: 999px; border:1px solid var(--border); color: var(--text); background: var(--card); box-shadow: var(--shadow); backdrop-filter: var(--glass); }
  .btn:hover { transform: translateY(-1px); }

  .hero { position: relative; padding: clamp(64px, 10vw, 120px) 0 40px; min-height: 70vh; display: grid; place-items: center; overflow: clip; }
  .hero-inner { position: relative; z-index: 2; text-align: center; max-width: 860px; padding-inline: 12px; }
  .eyebrow { display:inline-flex; align-items:center; gap:.5ch; padding:.35rem .75rem; border-radius: 999px; border: 1px solid var(--border); background: var(--card); color: var(--muted); font-size: .9rem; backdrop-filter: var(--glass); }
  .hero h1 { margin: 14px 0 10px; font-size: clamp(2.2rem, 5vw, 3.4rem); line-height: 1.1; letter-spacing: .3px; }
  .hero p { margin: 0 auto 20px; color: var(--muted); font-size: clamp(1.05rem, 1.6vw, 1.2rem); max-width: 65ch; }
  .cta { display:flex; gap: 12px; justify-content:center; flex-wrap:wrap; }
  .cta .btn.primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: white; border: none; }

  .hero::after { content: ""; position: absolute; inset: 55% 0 0 0; z-index: 1; background: linear-gradient(180deg, transparent, color-mix(in oklab, var(--bg) 80%, black 0%) 60%, var(--bg) 100%); }

  #waveCanvas { position: absolute; inset: auto 0 0 0; height: 220px; width: 100%; display: block; pointer-events: none; }

  section { position: relative; padding: 64px 0; }
  section::before { content:""; position:absolute; left:0; right:0; top:-24px; height:48px; pointer-events:none; background: linear-gradient(180deg, transparent, color-mix(in oklab, var(--bg) 85%, black 0%)); }

  .grid { display:grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 22px; box-shadow: var(--shadow); backdrop-filter: var(--glass); }
  .card h3 { margin: 0 0 8px; }
  .muted { color: var(--muted); }

  .list { display:grid; gap: 10px; }
  .list a { display:flex; align-items:center; justify-content:space-between; padding: 12px 14px; border-radius: 12px; border: 1px solid var(--border); background: var(--card); backdrop-filter: var(--glass); }

  table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 14px; border: 1px solid var(--border); background: var(--card); backdrop-filter: var(--glass); }
  th, td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border); }
  tbody tr:hover { background: color-mix(in oklab, var(--card) 70%, var(--bg) 30%); }
  [data-theme="dark"] tbody tr:hover { background: color-mix(in oklab, var(--card) 70%, var(--bg) 30%); }

  /* ===== Footer + Spectrum Analyzer ===== */
  footer { padding: 16px 0 0; color: var(--muted); border-top:1px solid var(--border); backdrop-filter: var(--glass); }
  .footer-wrap { display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap; padding: 20px 0; }
  .spec-shell {
    position: relative;
    width: 100%;
    border-top: 1px solid var(--border);
    background:
      linear-gradient(180deg, color-mix(in oklab, var(--card) 70%, var(--bg) 30%), transparent 80%),
      var(--card);
    backdrop-filter: var(--glass);
  }
  #specCanvas {
    display:block;
    width:100%;
    height:80px; /* visual height; JS will scale for DPR */
  }
  .spec-controls {
    display:flex; align-items:center; gap:10px;
    position:absolute; right: 16px; top: 10px;
  }
  .spec-btn { font-size:.85rem; padding:.35rem .7rem; }

  @media (max-width: 760px) { .nav-links { display:none; } }
</style>

</head>
<body>
  <header class="site-header">
    <div class="container">
      <nav>
        <div class="brand" aria-label="site">
          <span class="dot" aria-hidden="true"></span>
          <div>
            <div>K2WET</div>
            <small>Amateur Radio Station</small>
          </div>
        </div>
        <div class="nav-links" role="navigation" aria-label="primary">
          <a href="#home" class="active">Home</a>
          <a href="#about">About</a>
          <a href="#station">Station</a>
          <a href="#links">Links</a>
          <a href="#contact">Contact</a>
        </div>
        <div class="controls">
          <button class="btn" id="themeToggle" aria-label="Toggle theme" title="Toggle theme">üåó Theme</button>
        </div>
      </nav>
    </div>
  </header>

  <main>
    <section class="hero" id="home">
      <div class="hero-inner container">
        <span class="eyebrow">CQ ¬∑ CQ ¬∑ CQ</span>
        <h1>Calling all stations ‚Äî this is <span style="background:linear-gradient(135deg,var(--accent),var(--accent-2));-webkit-background-clip:text;background-clip:text;color:transparent">K2WET</span></h1>
        <p>A modern, single-file website template for amateur radio operators. Clean, accessible, and easy to customize ‚Äî with a live, animated radio wave on your homepage.</p>
      </div>
      <canvas id="waveCanvas" aria-hidden="true"></canvas>
    </section>

    <section id="about">
      <div class="container">
        <div class="grid">
          <article class="card">
            <h3>About the Operator</h3>
            <p class="muted">Replace this with your bio: license class, interests (HF, VHF/UHF, Satellites, POTA, SOTA), and when you‚Äôre typically on the air.</p>
          </article>
          <article class="card">
            <h3>QTH & Grid</h3>
            <p class="muted">City, state, and Maidenhead grid square (e.g., EM10). Add repeaters you monitor and clubs you belong to.</p>
          </article>
          <article class="card">
            <h3>On-Air Status</h3>
            <p class="muted" id="onAir">Frequntly Listening on 14.074 MHz (FT8) ‚Äî <em>idle</em>.</p>
          </article>
        </div>
      </div>
    </section>

    <section id="station">
      <div class="container">
        <div class="grid">
          <article class="card">
            <h3>Radios</h3>
            <p class="muted">Primary HF: ‚Ä¶ ¬∑ VHF/UHF: ‚Ä¶ ¬∑ Portable: ‚Ä¶ ¬∑ SDR: ‚Ä¶</p>
          </article>
          <article class="card">
            <h3>Antennas</h3>
            <p class="muted">HF: ‚Ä¶ ¬∑ 6 m: ‚Ä¶ ¬∑ 2 m/70 cm: ‚Ä¶ ¬∑ Portable: ‚Ä¶</p>
          </article>
          <article class="card">
            <h3>Software</h3>
            <p class="muted">Logging, digital modes (WSJT-X/JS8Call), CAT control, mapping, etc.</p>
          </article>
        </div>
      </div>
    </section>

    <section id="links">
      <div class="container grid">
        <article class="card">
          <h3>Useful Links</h3>
          <div class="list">
            <a href="#">FCC ULS</a>
            <a href="#">QRZ Profile</a>
            <a href="#">ClubLog</a>
            <a href="#">POTA</a>
            <a href="#">ARRL</a>
          </div>
        </article>
        <article class="card">
          <h3>QTH Map</h3>
          <div style="border-radius:12px; overflow:hidden; border:1px solid var(--border);">
            <iframe title="Map: Seguin ¬∑ New Braunfels ¬∑ San Marcos" width="100%" height="340" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://www.openstreetmap.org/export/embed.html?bbox=-98.35%2C29.45%2C-97.75%2C29.95&layer=mapnik"></iframe>
          </div>
          <small class="muted" style="display:block; margin-top:8px;">Seguin ¬∑ New Braunfels ¬∑ San Marcos ‚Äî <a href="https://www.openstreetmap.org/#map=10/29.70/-97.97" target="_blank" rel="noopener">View larger map</a></small>
        </article>
      </div>
    </section>

    <section id="contact">
      <div class="container">
        <div class="grid">
          <article class="card">
            <h3>Contact</h3>
            <p class="muted">This is a static form demo. Hook it up to your preferred form backend later.</p>
            <form onsubmit="event.preventDefault(); alert('Thanks! Message staged ‚Äî connect this form to your backend.');">
              <div class="grid" style="grid-template-columns:1fr 1fr;">
                <label> Name<br /><input required type="text" placeholder="Your name" style="width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background: var(--card); backdrop-filter: var(--glass);"></label>
                <label> Email<br /><input required type="email" placeholder="you@example.com" style="width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background: var(--card); backdrop-filter: var(--glass);"></label>
              </div>
              <label> Message<br /><textarea required rows="5" placeholder="How can we connect?" style="width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background: var(--card); backdrop-filter: var(--glass);"></textarea></label>
              <div style="margin-top:12px; display:flex; gap:10px;">
                <button class="btn primary" type="submit">Send Message</button>
                <a class="btn" href="#home">Back to Top</a>
              </div>
            </form>
          </article>
        	<article class="card">
          		<h3>QSL</h3>
          		<p class="muted">State your QSL policy (eQSL/LoTW/paper), and where to send cards. Add a QSL card image here if you like.</p>
          </article>
       </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="spec-shell">
      <canvas id="specCanvas" aria-hidden="true"></canvas>
      <div class="spec-controls">
        <button class="btn spec-btn" id="specToggle" title="Enable mic for live spectrum">üéôÔ∏è Enable</button>
        <button class="btn spec-btn" id="themeToggleFooter">üåó Theme</button>
      </div>
    </div>
    <div class="container footer-wrap">
      <div>¬© <span id="year"></span> [Your Callsign]. Built with ‚ô• for amateur radio.</div>
      <div class="muted" style="font-size:.9rem;">Footer spectrum shows live mic when enabled; otherwise, a subtle idle animation.</div>
    </div>
  </footer>

  <script>
    const root = document.documentElement; const THEME_KEY = 'ham-theme';
    function setTheme(mode){ root.setAttribute('data-theme', mode); localStorage.setItem(THEME_KEY, mode); }
    function initTheme(){ const saved = localStorage.getItem(THEME_KEY); if(saved){ setTheme(saved); } else if (window.matchMedia('(prefers-color-scheme: dark)').matches){ setTheme('dark'); } }
    initTheme();
    document.getElementById('themeToggle').addEventListener('click',()=>{ setTheme(root.getAttribute('data-theme')==='dark' ? 'light':'dark'); });
    document.getElementById('themeToggleFooter').addEventListener('click',()=>{ setTheme(root.getAttribute('data-theme')==='dark' ? 'light':'dark'); });
    document.getElementById('year').textContent = new Date().getFullYear();

    function applySectionToggles(){ const toggles = window.SECTION_TOGGLES || {}; const ids = ['home','about','station','links','contact']; ids.forEach(id => { const enabled = toggles[id] !== false; const sec = document.getElementById(id); if (sec) sec.hidden = !enabled; const nav = document.querySelector('.nav-links a[href="#'+id+'"]'); if (nav) nav.hidden = !enabled; }); }
    applySectionToggles();

    const navLinks = Array.from(document.querySelectorAll('.nav-links a:not([hidden])'));
    const allIds = ['home','about','station','links','contact'];
    const visibleIds = allIds.filter(id => { const sec = document.getElementById(id); return sec && !sec.hidden; });
    const opts = { rootMargin: '-40% 0px -55% 0px', threshold: 0 };
    const observer = new IntersectionObserver((entries)=>{ entries.forEach(e=>{ if(e.isIntersecting){ const id = '#' + e.target.id; navLinks.forEach(a=>a.classList.toggle('active', a.getAttribute('href') === id)); } }); }, opts);
    visibleIds.forEach(id=>{ const el=document.getElementById(id); if(el) observer.observe(el); });

    const onAirEl = document.getElementById('onAir');
    if(onAirEl){ const bands = ['160 m','80 m','40 m','30 m','20 m','17 m','15 m','12 m','10 m','6 m']; const modes = ['SSB','CW','FT8','FT4','JS8','AM','FM']; const freq = ['3.573','7.074','10.136','14.074','18.100','21.074','24.915','28.074','50.313']; const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)]; const update = () => { const f = pick(freq); const m = pick(modes); const b = pick(bands); onAirEl.innerHTML = `Listening on ${f}&nbsp;MHz (${m}) ‚Äî <em>${b}</em>`; }; update(); setInterval(update, 9000); }

    // ==== Animated radio wave with MOVING K2WET gradient ====
    (function(){
      const canvas = document.getElementById('waveCanvas');
      const ctx = canvas.getContext('2d');
      let width, height, dpr, t = 0;

      function getColors(){
        const cs = getComputedStyle(document.documentElement);
        return [
          cs.getPropertyValue('--accent').trim(),
          cs.getPropertyValue('--accent-2').trim(),
          cs.getPropertyValue('--accent-3').trim()
        ];
      }

      function resize(){
        dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
        const parent = canvas.parentElement;
        width = parent.clientWidth;
        height = Math.max(160, Math.min(260, Math.round(parent.clientHeight * 0.38)));
        canvas.width = Math.floor(width * dpr);
        canvas.height = Math.floor(height * dpr);
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.setTransform(1,0,0,1,0,0);
        ctx.scale(dpr, dpr);
      }

      function loop(){
        const [c1,c2,c3] = getColors();

        ctx.clearRect(0,0,width,height);

        // Subtle baseline
        ctx.globalAlpha = 0.08;
        ctx.beginPath();
        const baseY = height * 0.6;
        ctx.moveTo(0, baseY);
        ctx.lineTo(width, baseY);
        ctx.lineWidth = 1;
        ctx.strokeStyle = c1;
        ctx.stroke();
        ctx.globalAlpha = 1;

        // Moving gradient
        const gradShift = (t * 120) % (width || 1);
        const grad = ctx.createLinearGradient(-gradShift, 0, width - gradShift, 0);
        grad.addColorStop(0.00, c1);
        grad.addColorStop(0.50, c2);
        grad.addColorStop(1.00, c1);

        const amp = 14;
        const len = 180;
        const waveSpeed = 1.8;

        ctx.beginPath();
        for (let x = 0; x <= width; x += 2) {
          const y = baseY + amp * Math.sin((x / len) * Math.PI * 2 + t * waveSpeed);
          if (x === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        }

        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.strokeStyle = grad;
        ctx.shadowBlur = 12;
        ctx.shadowColor = c2;
        ctx.stroke();
        ctx.shadowBlur = 0;

        t += 0.012;
        requestAnimationFrame(loop);
      }

      resize();
      loop();
      window.addEventListener('resize', resize);
      const obs = new MutationObserver(resize);
      obs.observe(document.documentElement, { attributes:true, attributeFilter:['data-theme'] });
    })();

      // ====== Footer Spectrum Analyzer (line trace) ======
    (function(){
      const canvas = document.getElementById('specCanvas');
      const ctx = canvas.getContext('2d');
      const enableBtn = document.getElementById('specToggle');

      let dpr = 1, width = 0, height = 0;
      let audioCtx = null, analyser = null, dataArray = null, source = null;
      let usingMic = false, running = true, t = 0;

      // smoothing buffer for a steadier line
      let smooth = [];

      function getColors(){
        const cs = getComputedStyle(document.documentElement);
        return {
          c1: cs.getPropertyValue('--accent').trim(),
          c2: cs.getPropertyValue('--accent-2').trim(),
          c3: cs.getPropertyValue('--accent-3').trim(),
          border: cs.getPropertyValue('--border').trim(),
          card: cs.getPropertyValue('--card').trim()
        };
      }

      function resize(){
        dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
        width = canvas.clientWidth;
        height = canvas.clientHeight;
        canvas.width = Math.floor(width * dpr);
        canvas.height = Math.floor(height * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }

      async function enableMic(){
        try{
          if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          analyser = audioCtx.createAnalyser();
          analyser.fftSize = 512;               // finer line than before
          analyser.smoothingTimeConstant = 0.7; // natural decay
          dataArray = new Uint8Array(analyser.frequencyBinCount);
          source = audioCtx.createMediaStreamSource(stream);
          source.connect(analyser);
          usingMic = true;
          enableBtn.textContent = '‚è∏Ô∏è Pause';
          enableBtn.title = 'Pause visualization';
        } catch {
          usingMic = false;
          enableBtn.textContent = '‚ö†Ô∏è Mic blocked';
          enableBtn.title = 'Microphone access was denied';
          enableBtn.disabled = true;
        }
      }

      function toggle(){
        if (!usingMic && !audioCtx){ enableMic(); return; }
        running = !running;
        enableBtn.textContent = running ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Play';
      }
      enableBtn.addEventListener('click', toggle);

      // Map linear FFT bins to a pseudo-log scale for a more ‚ÄúSA‚Äù feel
      function sampleOnLogScale(src, nOut){
        const out = new Array(nOut);
        const N = src.length;
        for (let i=0; i<nOut; i++){
          const p = i / (nOut - 1);
          const idx = Math.min(N - 1, Math.floor(Math.pow(p, 1/2) * (N - 1))); // sqrt curve
          out[i] = src[idx] / 255;
        }
        return out;
      }

      function drawGrid(colors){
        // subtle grid
        ctx.lineWidth = 1;
        ctx.strokeStyle = colors.border;
        ctx.globalAlpha = 0.25;

        // horizontal
        const rowH = Math.max(10, Math.floor(height / 6));
        for(let y=rowH; y<height; y+=rowH){
          ctx.beginPath(); ctx.moveTo(0, y+0.5); ctx.lineTo(width, y+0.5); ctx.stroke();
        }

        // vertical
        const colW = Math.max(32, Math.floor(width / 12));
        for(let x=colW; x<width; x+=colW){
          ctx.beginPath(); ctx.moveTo(x+0.5, 0); ctx.lineTo(x+0.5, height); ctx.stroke();
        }

        ctx.globalAlpha = 1;
      }

      function draw(){
        const colors = getColors();
        ctx.clearRect(0,0,width,height);
        drawGrid(colors);

        // Get values (mic or idle synth)
        const bins = 160; // points in the trace
        let values;

        if (usingMic && analyser && running){
          analyser.getByteFrequencyData(dataArray);
          values = sampleOnLogScale(dataArray, bins);
        } else {
          values = new Array(bins);
          for (let i=0; i<bins; i++){
            const phase = (i/bins) * Math.PI * 2;
            values[i] = (Math.sin(phase*1.2 + t*1.3) + Math.sin(phase*2.4 + t*0.7)*0.6 + 2.1)/3.1;
          }
        }

        // Smooth line via simple exponential moving average
        const alpha = 0.6; // higher = snappier
        if (smooth.length !== bins) smooth = values.slice();
        for (let i=0;i<bins;i++){
          smooth[i] = alpha*values[i] + (1-alpha)*smooth[i];
        }

        // Convert to canvas coords
        const pts = smooth.map((v,i)=>{
          // add slight curve emphasis toward the top
          const eased = Math.pow(Math.min(1, v), 0.85);
          const x = i * (width / (bins - 1));
          const y = height - (eased * (height - 4)) - 2;
          return [x,y];
        });

        // Trace gradient + glow
        const grad = ctx.createLinearGradient(0, 0, width, 0);
        grad.addColorStop(0.00, colors.c1);
        grad.addColorStop(0.50, colors.c2);
        grad.addColorStop(1.00, colors.c1);

        // soft fill under the curve
        ctx.beginPath();
        ctx.moveTo(pts[0][0], height);
        pts.forEach(([x,y])=>ctx.lineTo(x,y));
        ctx.lineTo(pts[pts.length-1][0], height);
        ctx.closePath();
        ctx.globalAlpha = 0.12;
        ctx.fillStyle = grad;
        ctx.fill();
        ctx.globalAlpha = 1;

        // line stroke with glow
        ctx.beginPath();
        ctx.moveTo(pts[0][0], pts[0][1]);
        for (let i=1;i<pts.length;i++) ctx.lineTo(pts[i][0], pts[i][1]);
        ctx.lineWidth = 2.2;
        ctx.lineJoin = 'round';
        ctx.lineCap  = 'round';
        ctx.strokeStyle = grad;
        ctx.shadowBlur = 10;
        ctx.shadowColor = colors.c2;
        ctx.stroke();
        ctx.shadowBlur = 0;

        if (running) t += 0.016;
        requestAnimationFrame(draw);
      }

      resize();
      draw();
      window.addEventListener('resize', resize);
      new MutationObserver(resize).observe(document.documentElement, { attributes:true, attributeFilter:['data-theme'] });

      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches){
        running = false;
        enableBtn.textContent = '‚ñ∂Ô∏è Play';
      }
    })();
  </script>
</body>
</html>
